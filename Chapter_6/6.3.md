# 6.3 异步任务及邮件发送

## 概要：

本课时讲解如何使用 sidekiq 实现异步任务，以及如何使用 ActionMailer 发送邮件。

## 知识点：

1. ActiveJob
2. sidekiq
3. ActionMailer

## 正文

### 6.3.1 ActiveJob

在 Rails 4.2 之前，经常使用 [Delayed Job](https://github.com/collectiveidea/delayed_job)，[Resque](https://github.com/resque/resque)，[Sidekiq](https://github.com/mperham/sidekiq) 这三种异步服务，处理后端任务，比如邮件发送，报表计算，用户动态等等。

这些任务具备一些特点：

* 执行时间长，比如为所有关注我的用户创建好友动态。
* 可以和前段操作分开执行，比如用户注册后，直接进入界面，而后端任务在稍后把欢迎邮件发出。
* 调用其他应用的 api

异步任务可以解决这些问题，但是三种常用的异步任务有各自的方法调用，Rails 4 中使用 [ActiveJob](http://guides.rubyonrails.org/active_job_basics.html) 来编写统一的操作代码，这样即便后端服务更换，也不用更改业务逻辑代码了。

### 6.3.2 Sidekiq

Sidekiq 使用 redis 储存任务，并且一个进程可以等于20个 Resque 或 DelayedJob 进程（官网上的说法）。

[redis](https://github.com/antirez/redis) 的安装非常简单，下载[安装包](http://redis.io/download)，进入 src 目录：

```
redis-server
```

这样一个命令就可以启动 redis 服务了。在生产环境下，可以针对文件位置等配置，可以增加一个 redis.conf 文件，启动时选择：

```
redis-server .conf/redis.conf
```

这里我做了两个修改：

```
dir ./db/redis/ [1]
logfile ./log/redis.log [2]
```

[1] 在我们的 db 下建立 redis 目录，放置 redis 数据库文件
[2] redis 日志放入项目日志目录中

安装 sidekiq 需要两个 gem：

```
gem 'sidekiq'
gem 'sinatra', :require => nil
```

通常我们需要 sidekiq 的管理界面，来查看当前的任务队列情况，sinatra 可以单独启动这个管理服务， 我们修改一下 routes：

`config/routes.rb`

```
require 'sidekiq/web'
mount Sidekiq::Web => '/sidekiq'
```

我们再增加一个 sidekiq 的配置文件 `config/sidekiq.yml`，然后运行它：

```
sidekiq -C config/sidekiq.yml

         s
          ss
     sss  sss         ss
     s  sss s   ssss sss   ____  _     _      _    _
     s     sssss ssss     / ___|(_) __| | ___| | _(_) __ _
    s         sss         \___ \| |/ _` |/ _ \ |/ / |/ _` |
    s sssss  s             ___) | | (_| |  __/   <| | (_| |
    ss    s  s            |____/|_|\__,_|\___|_|\_\_|\__, |
    s     s s                                           |_|
          s s
         sss
         sss 
```

这样便启动了 sidekiq 服务，我们用它来完成异步任务。

### 6.3.3 异步任务，Job

我们用 generate 来创建一个任务类：

```
rails generate job order_create
```

OrderCreateJob 用来处理订单创建时，需要额外完成的一些操作，比如，向这个订单的用户发送一封 “订单已确认” 的邮件。我们使用 after_create 这个回调，来触发这个异步任务。

```
class Order < ActiveRecord::Base
  ....
  after_create :send_create_email
  def send_create_email
    OrderCreateJob.perform_later(self)
  end
```

```
class OrderCreateJob < ActiveJob::Base
  queue_as :default

  def perform(order)
	...
  end
end
```

### 6.3.4 使用 ActionMailer 发送邮件



