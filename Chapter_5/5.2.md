# 5.2 控制器中的逻辑

## 概要

本课时讲解如何实现网店的购物车和支付功能，以及使用 datatable 查看订单数据。

## 知识点

1. 权限设置
2. 状态变更
3. 支付
4. 数据列表

## 正文

### 5.2.1 权限控制

Controller 除了对请求作出相应，另一个重要的事情是做权限控制，只有拥有权限的用户才可以触发方法。权限管理有终端 gem，常用的有 [cancan](https://github.com/ryanb/cancan)，[pundit](https://github.com/elabs/pundit) 等。

由于 cancan 已经两年没有维护了，所以Ruby社区推出cancan 的社区版 [cancancan](https://github.com/CanCanCommunity/cancancan)。

```
% rails g cancan:ability
  create  app/models/ability.rb
```

编辑 ability.rb，我们的权限是：当一个 user（已登录）字段 role 是 admin 时，可以管理所有资源，否则，只能管理它自己的资源。

```
user ||= User.new # guest user (not logged in)
if user.admin?
  can :manage, :all
else
  can :read, :all [1]
  can :manage, Address, :user_id => user.id [2]
end
```

[1] 非管理员可读所有

[2] 用户管理自己的收货地址

我们给 `users` 表添加 role 字段：

```
rails g migration addRoleToUsers role:string
```

在视图中判断权限：

```
<%= link_to "Edit", edit_product_path(product) if can? :update, product %>
```

这里有四个动作可以判断：`:read`，`:create`，`:update`，`:destroy`。

我们在 Controller 中增加 `load_and_authorize_resource` 回调，这个回调将自动加载一个资源，并且进行权限校验，这适合资源管理中的方法：

```
class ProductsController < ApplicationController
  load_and_authorize_resource
```

也可以将这个回调分成两个回调，这样方便覆写其中的方法：

```
class ProductsController < ApplicationController
  load_resource
  authorize_resource
```

更多文档详见 [这里](https://github.com/CanCanCommunity/cancancan/wiki/authorizing-controller-actions)。


也可以不实用回调，直接在方法上判断权限，比如判断当前用户是否可以创建商品：

```
class ProductsController < ApplicationController
  ...
  def create
    authorize! :create, @product
    ...
```

cancancan 更多用法，详见 [wiki](https://github.com/CanCanCommunity/cancancan/wiki)。

### 5.2.2 购物车

购物车有多种设计思路，有的会把信息保存在 cookie 中，有的保存在数据库中。购物车是一个未创建的订单，我们将它保存到数据库中，登录后可见自己的购物车内的物品。

https://github.com/pluginaweek/state_machine

### 5.2.3 支付

https://github.com/chloerei/alipay

### 5.2.4 数据列表


我的订单，datatable，

https://datatables.net
www.datatables.net/examples/server_side/simple.html

### 5.2.5 Rspec



