# 2.3 深入 routes

## 概要：

本课时详细解读如何在 routes 中实现各种路由请求。

## 知识点：

1. routes 定义
2. 嵌套（nested）
3. namespace
4. module

## 正文

### 2.3.1 定义 routes

上一节，我们讲了 Rails 通过 routes，来实现 REST 风格的架构。本节我们讲详细介绍下如何使用 routes，定义我们想要的地址（URL）。

我们先为项目，创建一个 controller：

```
rails g controller home index welcome about contact 
```

在我们专门讲解 controller 前，先简单解释下：

* g 是 generate 的缩写，我想你已经在 2.1.1 里看到了。
* controller，说明我们创建的是一个 controller，也可以是 model。
* home 是 controller 的名字。
* index... 和其他几个名字，是 controller 中的方法，并且会自动创建对应的 views 文件。

好了，我们在它上面做一些简单的例子，打开routes，你可以看到它已经增加了几个定义：

```
get 'home/index'
get 'home/welcome'
get 'home/about'
get 'home/contact'
```
我们访问 `http://localhost:3000/home/index` 可以看到它。但是，如果我想访问 `http://localhost:3000/` 就进入到 index 方法呢？

```
get '/', to: 'home#index'
get '/welcome', to: 'home#welcome'
```
如上，我们自己定义了访问和方法之间的对应关系。其实我们更经常使用 root 来定义地址：

```
root 'home#index'
```

运行 `rake routes`，我们可以看到

Prefix | Verb | URI Pattern | Controller#Action
--- | --- | --- | ---
home_contact | GET | /home/contact(.:format) | home#contact
 | GET | / | home#index
welcome | GET | /welcome(.:format) | home#welcome
root | GET | / | home#index

我们也可以用其他的 Verb 来定义非 GET 请求，比如

```
put '/haha', to: 'home#index'
delete '/hehe', to: 'home#index'
patch '/wawa', to: 'home#index'
```

#### resources

前面我们已经定义了一个 `resource :products`，这在实际开发中还是不够的，比如，一个 Product 下如果查看评论，比如，显示卖的最好的十个 Products：

```
resources :products do
  collection do
    get :top
  end
  member do
    get :comments
  end
end
```
运行 `rake routes` 可以看到：

Prefix | Verb | URI Pattern | Controller#Action
--- | --- | --- | ---
top_products | GET | /products/top(.:format) | products#top
comments_product | GET | /products/:id/comments(.:format) | products#comments

不同的是，collection 用于 products 中增加方法，member 给具体一个 product 增加方法。

补充一点，我们可以在一行里，定义多个 resources，比如：

```
resources :photos, :books, :videos
```
虽然方便，但不够灵活，实践中还是要按照需求调整的。

#### resource

```
resource :settings
resource :profile
```

这是设定一个单数资源的方法，项目里，哪些是单数呢？比如系统设定，比如当前用户的个人信息，运行 `rake routes` 可以看到，它是没有 `:id` 这个参数的。

在这个例子里，我们还未给 settings 和 profile 创建 controller 和 view，不过这不妨碍 routes 产生我们想要的地址。

#### 选择方法

`resources` 给我们创建了七个方法，但是不见得我们都要用到，为了代码的整洁[1]，我们可以做一些排除：

```
resources :users, only: [:index, :show]
resources :products, except: [:destroy]
```

`only` 表示我们需要的方法，`except` 表示我们不需要的方法。通常，我们的确会像上面这么做，比如我们的网站只提供用户（User）的列表和查看功能，而管理功能（增删改）要在管理界面进行，而它的地址一般不会是 `/users/1/edit` 这样，而是 `/admin/users/1/edit`。

[1]这是个人癖好，有的人的确不愿意这么做，不过 Rails 给了我们让项目变得“整洁”的方法。

#### 非资源地址

routes 中我们可以抛开资源的要求（非 REST 风格），直接设定一个访问地址：

```
get '/something/:controller/:name/:action'
```

这时我们访问 `http://localhost:3000/home/aaa/index` 也会进入到 `'home#index'` 中，因为 Rails 会 这样解析：

* something 是个前缀
* 访问的 controller 是 home
* name 参数是 aaa
* 方法是 index

建议你看一下的终端：

```
Started GET "/something/home/aaa/index" for ::1 at 2015-02-19 17:10:26 +0800
Processing by HomeController#index as HTML
  Parameters: {"name"=>"aaa"}
```

Rails 已经将你的请求转移到对应的 controller 中了。

提示：在开发（development）环境中，修改 routes 是不需要重启服务的。

#### :as

如果再上面地址后面，加上 `as` 参数，会直接创建一个别名的地址，比如

```
get 'home/welcome', as: :welcome
```

之前，我们在 views 或者 controller 中，连接到或跳转到 `/home/index` 可以这么写：`home_welcome_path`，增加了 `:as` 后，就变成了 `welcome_path` 了。好处是，如果我们某一天更改了对应的 action 甚至 controller，这个写法 `welcome_path` 是不会变的，而只需要改动 routes 中的定义。

#### 地址解析

刚才，我们讲到了 `_path` 这个后缀，Rails 还有一个 `_url`。

地址 | 结果
--- | ---
products_path | '/products'
products_url | 'http://localhost:3000/products'

`_path` 和 `_url` 是 routes 的辅助方法，我们在下一章将详细介绍。

### 2.3.2 嵌套的 routes

### 2.3.3 route 中的 namespace

### 2.3.4 route 中的 module

### 2.3.5 有用的参数

#### shallow

#### concern

#### constraints

#### root

### 2.3.6 Rspec




