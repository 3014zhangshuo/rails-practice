# 第二章 Rails 中的资源

## 课程概要：

本课程通过 scaffold 命令，创建一个资源（Product），讲解资源文件含义，并详解 REST 风格设计，以及深入路由（routes）文件，讲解 Rails 如何实现 REST 架构的。

## 知识点：

1. scaffold 命令
2. REST
3. routes

## 课程背景

使用 scaffold 命令，快速的创建符合 REST（Representational State Transfer）要求的文件架构，并通过对 REST 的学习，了解 Rails 如何处理和响应 Web 请求。

# 2.1 用 scaffold 创建资源

## 概要：

本课时详细介绍 scaffold 命令创建的资源文件。

## 知识点：

1. scaffold
2. sass/scss
3. coffeescript
4. erb
5. minitest
6. rspec

## 正文

### 2.1.1 scaffold 命令

上一节，我们用 `new` 创建了一个 Rails 项目，并且使用了下面的命令，创建了商品（Product）这个资源：

```
rails g scaffold product name price:decimal description:text
```

我们来详细的看看这行命令。

g 是 generate 的缩写，Rails 为我们提供了几个类似的命令：

```
% rails -h
generate    用它来创建代码 (简写 "g")
console     运行调试控制台 (简写 "c")
server      运行 Rails 服务 (简写 "s")
dbconsole   运行数据库调试控制台 (简写 "db")
new         创建新的 Rails 项目。 你也可以 "rails new ." 它会在当前目录下创建
destroy     删除 "generate" 创建的文件 (简写 "d")
```

我们用 generate 可以创建资源，同样也可以用 destroy 删除这个资源，比如：

```
rails destroy scaffold product
```

scaffold 的中文称呼是 “脚手架”，个人觉得它不是很形象，如果称它为“一大堆 generator（生成器） 的集合”，似乎形象很多。Rails 为我们提供了一些 generator，用来创建各种文件。scaffold 将这些 generator 一次运行了。

举个栗子。我们创建一个 Model 文件，这样写：

```
rails g model product
```

使用 scaffold 时，我们写的每一个部分为：

```
rails g scaffold [资源名] [属性列表] [参数]
```

那么刚才的命令，我们创建了这些文件：

```
invoke  active_record
create    db/migrate/20150216160325_create_products.rb
create    app/models/product.rb
invoke    test_unit
create      test/models/product_test.rb
create      test/fixtures/products.yml
invoke  resource_route
route    resources :products
invoke  scaffold_controller
create    app/controllers/products_controller.rb
invoke    erb
create      app/views/products
create      app/views/products/index.html.erb
create      app/views/products/edit.html.erb
create      app/views/products/show.html.erb
create      app/views/products/new.html.erb
create      app/views/products/_form.html.erb
invoke    test_unit
create      test/controllers/products_controller_test.rb
invoke    helper
create      app/helpers/products_helper.rb
invoke      test_unit
invoke    jbuilder
create      app/views/products/index.json.jbuilder
create      app/views/products/show.json.jbuilder
invoke  assets
invoke    coffee
create      app/assets/javascripts/products.coffee
invoke    scss
create      app/assets/stylesheets/products.scss
invoke  scss
identical    app/assets/stylesheets/scaffolds.scss
```

如何理解这些文件的用途？我想先介绍一下“资源”这个概念。scaffold 创建了一个 product 的资源。它在系统里是复数存在的，只有在 model 中，它是单数。


生成文件的时候，我们注意到：

```
...
route resources :products
...
```

打开 `config/routes.rb` 可以看到这就是我们定义的资源。其实，我们说 URL 中的 R 就是这个资源 Resource 的意思。我们可以这样理解 Rails：

> Rails 是从如何管理资源开始的。

scaffold 还为我们创建了 MVC 所用的文件，这在我们下一章开始介绍。先简单的介绍下，M 就是 `app/models/product.rb` 中的数据库模型，V 就是 `app/views/products` 中的视图文件，C 就是 `app/controllers/products_controller.rb` 中的控制器文件。

我们还可以配置 scaffold，让它跳过一些不必要的文件，配置写在 `config/application.rb` 中：

```
class Application < Rails::Application
  ...
  config.generators do |cfg|
    cfg.stylesheets     false
    cfg.javascripts     false
    cfg.helpers         false
  end
```

这样，scaffold 命令就不再创建 helper，css，js 文件了。但在我们学习初期阶段，先不这么做。

### 2.1.2 测试

除了上面介绍的，scaffold 还为我们添加了测试文件 `test/models/product_test.rb` 和 `test/controllers/products_controller_test.rb`。

这里，Rails 默认使用的是 minitest，更多介绍可以看[这里](http://docs.seattlerb.org/minitest/)。我们也可以使用其他的测试框架，比如 Rspec。

我们可以修改 Gemfile

```
group :development, :test do
  gem 'rspec-rails'
end
```

运行 rspec 的 generator：

```
% rails generate rspec:install
create  .rspec
create  spec
create  spec/spec_helper.rb
create  spec/rails_helper.rb
```

我们补上 Model 和 Controller 的测试文件：

```
rails generate rspec:model product
rails generate rspec:controller products
```

最后，我们在 Rails 项目文件夹中运行这个命令：

```
% rspec
**

Pending: (Failures listed here are expected and do not affect your suite's status)

  1) ProductsController 
     # Not yet implemented
     # ./spec/controllers/products_controller_spec.rb:4

  2) Product add some examples to (or delete) /Users/liwei/Desktop/Rails_practice_p1_0/code/chapter_2/shop/spec/models/product_spec.rb
     # Not yet implemented
     # ./spec/models/product_spec.rb:4


Finished in 0.00058 seconds (files took 1.6 seconds to load)
```

我们看到测试文件已经可以运行了，虽然我们还未给它写一行测试用例（Test Case）。

在后面 MVC 开发的部分，我们会继续添加它的代码。Rspec 的代码和文档在这里：

[https://github.com/rspec/rspec](https://github.com/rspec/rspec)

让 Rspec 集成到 Rails 中的方法是安装 `rspec-rails`：

```
group :development, :test do
  gem 'rspec-rails', '~> 3.0'
end
```

[https://github.com/rspec/rspec-rails](https://github.com/rspec/rspec-rails)

### 2.1.3 scss

上面的文件中，我们看到了 `.scss` 的文件，其实，它是 `sass` 文件，一种 css 的预编译文件，它的后缀有两种：`.scss` 和 `.sass`。`.scss` 较常见，是因为它更接近 css 本身。你可以直接粘贴 css 来使用。sass 和 scss 写法上的不同，可以在 [http://sass-lang.com/guide](http://sass-lang.com/guide) 看到。

[SASS用法指南](http://www.ruanyifeng.com/blog/2012/06/sass.html) 一文里有更详细的介绍。

### 2.1.4 coffeescript

`.coffee` 是 js 的预编译文件，它是用 coffeescript 编写的。学习它很简单，只要看看[http://coffeescript.org/](http://coffeescript.org/) 就可以了，中文在 [http://coffee-script.org/](http://coffee-script.org/)。

scss 和 coffeescript 的目标，是让代码更简洁，易维护。预编译还可以帮你检查语法上的错误。

### 2.1.5 erb

最后，我们说说 erb。

erb 是 Ruby 的标准库（Standard Library）之一， 它允许是把 Ruby 代码签入到 html 中。

一个简单的例子，我们进入到 irb 中：

```
% require "erb"
% name = "Ruby"
% ERB.new("My name is #{name}").result
=> "My name is Ruby"
```

好了，文件都介绍完了，我们看一下效果吧，我们使用下面的命令：

```
rake db:migrate [1]
rails s [2]
```

* [1] 更新数据库
* [2] 启动 Rails 服务，s 是 server 的简写

访问 `http://localhost:3000/products`，试试上面的按钮，体验一下如何增加，修改，删除一个商品（Product）吧。

下一节，我们将深入 Rails 中，了解它的核心概念：REST。
