# 3.3 视图（View）中的 ajax

## 概要：

本课时通过评论（comments）的添加和管理，讲解 view 中如何使用 ajax。

## 知识点：

1. ujs
2. ajax
3. json

## 正文

上一节，我们讲解了 Rails 中的实图（View），我们再回顾一下这个视图是如何产生的：我们向服务器发起一个请求，比如某个地址，服务器返给我们结果，查看源代码，它是一篇 `HTML` 的代码。

我们每次请求一个地址，都会给我们完整的 HTML 结果，对于内容较少的网页，传输起来还是很快的，但是对于内容多的网页，大篇的结果自然会拖慢页面显示。

当我们浏览页面的时候，并不期望总是刷新整个页面，因为它没必要。现在我们有 ajax 技术，可以只加载和显示部分页面代码。举个简单的例子：当我们提交了一条评论，页面上自动显示出我们提交的评论内容。我们点击购买按钮，页面上就提示我们购物车里增加了一个商品。而这些，都不必要刷新整个页面。

下面我们看下 Rails 是如何把 ajax 技术应用在视图（View）中的。

### ujs

我们在 Gemfile 中已经使用了 `gem 'jquery-rails'` 这个 Gem，它可以让我们在 `application.js` 中增加这两行：

```
//= require jquery
//= require jquery_ujs
```

[jQuery](http://jquery.com/) 是一个轻量级的 js 库，可以方便的处理HTML，事件（Event），动态效果，为页面提供 ajax 交互。jQuery 有很完善的文档及演示代码，以及大量的插件。

[jquery_ujs](https://github.com/rails/jquery-ujs) 使 Rails 更好得支持 jQuery。我们来看一个例子：

![](../source/images/chapter_3/5.png)

我们给删除连接增加了一个参数：

```
<%= link_to "删除", product, :method => :delete, :data => { :confirm => "点击确定继续" } %>
```

来看看我们的 HTML：

```
<a data-confirm="点击确定继续" rel="nofollow" data-method="delete" href="/products/1">删除</a>
```

辅助方法 `link_to` 使用了 `:data => { :confirm => "点击确定继续" }` 这个参数，为我们添加了 `data-confirm="点击确定继续"` 这样的 HTML 代码，而 ujs 将它处理成一个弹出框。

更多 ujs 支持的方法，我们在[这里](https://github.com/rails/jquery-rails/blob/master/vendor/assets/javascripts/jquery_ujs.js)看到。

比如 a 标签可以支持 `data-disable-with`，那我们为上一节的 form 中的按钮，增加这个属性：

```
<%= f.submit nil, :data => { :"disable-with" => "请稍等..." } %>
```

![](../source/images/chapter_3/6.png)

如果你还没看清楚效果，页面就已经跳转了，我们可以给 create 方法增加一个 `sleep 10`：

```
def create
  sleep 10
  @product = Product.new(product_params)
  ...
```

这就是 ujs 给我们带来的一些便利。不过，还远不止这些，我们来点复杂的：在不刷新页面的情形下，添加一个商品，并显示在列表中。

我们现在的列表页是这样的：

![](../source/images/chapter_3/7.png)

现在点击添加，我们会进入到 `http://localhost:3000/products/new`，我们并不改变它，毕竟在某些 js 失效的情形下，点击这个按钮还是要跳转到 new 页面的。

我们希望给页面增加一个表单，来输入新商品的信息，在这之前，我们想更酷一点，我们使用 `modal` 来显示这个表单：

```
<%= link_to t('.new', :default => t("helpers.links.new")), new_product_path, :class => 'btn btn-primary', data: {toggle: "modal", target: "#productForm"} %>
```

ujs 允许我们在 link 上增加额外的属性，当我们再次点击 `添加` 按钮时：

![](../source/images/chapter_3/8.png)

当然我做了其他一些修改，你可以在 [这里](https://github.com/liwei78/rails-practice-code/tree/master/chapter_3/shop3.3) 找到完整的代码。

为了使用 ujs，我们在表单上增加一个参数 `remote: true`：

```
<%= form_for @product, remote: true, :html => { :class => 'form-horizontal' } do |f| %>
```

ujs 允许我们返回一段 js 代码，并且在页面上执行，所以，我们给 products_controller.rb 中的 create 方法，增加一种返回结果：js

我们创建一个新文件 `app/views/products/create.js.erb`，在这里，我们将新添加商品，显示在上面的列表中。

```
$('#productsTable').prepend('<%= j render(@product) %>');
$('#productFormModal').modal('hide');
```

我们将一行商品信息使用 `prepend` 方法，插入到 `productsTable` 的最上面，`j` 方法将我们的字符串转换成 js 片段。

你可能也像我一样做了一些测试，导致插入了很多测试信息，我们给 `删除` 按钮上也增加一个 ujs 调用。

我们给每一行记录，增加一个唯一的 ID 标识，通常使用名字 + id 的形式，我们编辑 `app/views/products/_product.html.erb`：

```
<tr id="product_<%= product.id %>">
...
```

我们再增加一个 ujs 文件 `app/views/products/destroy.js.erb`：

```
$('#product_<%= @product.id %>').fadeOut();
```

我们使用 `.js.erb` 的文件，方便我们在 js 文件里插入 erb 的语法。但是，这样会把我们的返回结果增加很多无用的内容，我们看一下添加商品时的返回结果：

```
$('#productsTable').prepend('<tr id=\"product_14\">\n  <td><a href=\"/products/14\">kkk<\/a><\/td>\n  <td>jjj<\/td>\n  <td class=\"text-right\">CN¥ 999.00<\/td>\n  <td>2015年2月26日 星期四 23:57:55<\/td>\n  <td>\n    <a class=\"btn btn-primary btn-xs\" href=\"/products/14/edit\">编辑<\/a>\n    <a data-confirm=\"点击确定继续\" class=\"btn btn-danger btn-xs\" data-remote=\"true\" rel=\"nofollow\" data-method=\"delete\" href=\"/products/14\">删除<\/a>\n  <\/td>\n<\/tr>\n');
$('#productFormModal').modal('hide');

```

这里面大部分代码是不必要的，因为我们只需要返回添加的商品信息，而且也不是全部信息，如何让我们的返回结果更简洁呢？这时我们可以用到 ajax 技术了。

PS：当然，我们也可以保持 erb 的方式，让返回结果更简洁，读者不放试试看。这里绝无谁好谁坏的比较，一切要看应用场景的不同。

### ajax



### json

