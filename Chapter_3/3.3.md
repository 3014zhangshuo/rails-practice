# 3.3 视图（View）中的 ajax

## 概要：

本课时通过评论（comments）的添加和管理，讲解 view 中如何使用 ajax。

## 知识点：

1. ujs
2. ajax
3. json

## 正文

上一节，我们讲解了 Rails 中的实图（View），我们再回顾一下这个视图是如何产生的：我们向服务器发起一个请求，比如某个地址，服务器返给我们结果，查看源代码，它是一篇 `HTML` 的代码。

我们每次请求一个地址，都会给我们完整的 HTML 结果，对于内容较少的网页，传输起来还是很快的，但是对于内容多的网页，大篇的结果自然会拖慢页面显示。

当我们浏览页面的时候，并不期望总是刷新整个页面，因为它没必要。现在我们有 ajax 技术，可以只加载和显示部分页面代码。举个简单的例子：当我们提交了一条评论，页面上自动显示出我们提交的评论内容。我们点击购买按钮，页面上就提示我们购物车里增加了一个商品。而这些，都不必要刷新整个页面。

下面我们看下 Rails 是如何把 ajax 技术应用在视图（View）中的。

### ujs

我们在 Gemfile 中已经使用了 `gem 'jquery-rails'` 这个 Gem，它可以让我们在 `application.js` 中增加这两行：

```
//= require jquery
//= require jquery_ujs
```

[jQuery](http://jquery.com/) 是一个轻量级的 js 库，可以方便的处理HTML，事件（Event），动态效果，为页面提供 ajax 交互。jQuery 有很完善的文档及演示代码，以及大量的插件。

[jquery_ujs](https://github.com/rails/jquery-ujs) 使 Rails 更好得支持 jQuery。我们来看一个例子：

![](../source/images/chapter_3/5.png)

我们给删除连接增加了一个参数：

```
<%= link_to "删除", product, :method => :delete, :data => { :confirm => "点击确定继续" } %>
```

来看看我们的 HTML：

```
<a data-confirm="点击确定继续" rel="nofollow" data-method="delete" href="/products/1">删除</a>
```

辅助方法 `link_to` 使用了 `:data => { :confirm => "点击确定继续" }` 这个参数，为我们添加了 `data-confirm="点击确定继续"` 这样的 HTML 代码，而 ujs 将它处理成一个弹出框。

更多 ujs 支持的方法，我们在[这里](https://github.com/rails/jquery-rails/blob/master/vendor/assets/javascripts/jquery_ujs.js)看到。

比如 a 标签可以支持 `data-disable-with`，那我们为上一节的 form 中的按钮，增加这个属性：

```
<%= f.submit nil, :data => { :"disable-with" => "请稍等..." } %>
```

![](../source/images/chapter_3/6.png)

如果你还没看清楚效果，页面就已经跳转了，我们可以给 create 方法增加一个 `sleep 10`：

```
def create
  sleep 10
  @product = Product.new(product_params)
  ...
```

这就是 ujs 给我们带来的一些便利。不过，还远不止这些，我们来点复杂的。




### ajax

### json

