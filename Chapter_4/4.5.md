# 4.5 模型中的回调（Callback）

## 概要：

本课时将讲解 ActiveRecord 中常用的回调方法，设计网店购物车及库存变动逻辑。

## 知识点：
 
1. callback
2. 购物车
3. 库存变动

## 正文

### 4.5.1 ActiveModel 中的回调

[ActiveModel](https://github.com/rails/rails/tree/master/activemodel) 提供了多个实用的功能，让一个普通的类，具备了属性校验，回调，I18n 等众多功能，比如：

```
class Person
  extend ActiveModel::Callbacks
  define_model_callbacks :create

  def create
    run_callbacks :create do
      # Your create action methods here
    end
  end
end
```

这个例子中，使用 [Callback](http://api.rubyonrails.org/classes/ActiveModel/Callbacks.html) 为普通的 Person 类增加了一个回调方法。所谓回调，是指在完成这个方法前/后，执行其他的代码。

这里涉及大量的 Ruby 元编程的知识，如果你感兴趣，可以读一读《[Ruby 元编程（第二版）](https://pragprog.com/book/ppmetr2/metaprogramming-ruby-2)》这本书。

ActiveRecord 中的 [回调](http://api.rubyonrails.org/classes/ActiveRecord/Callbacks.html) 将 `create`，`update`，`destroy` 方法进行 [包装](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/callbacks.rb)，在它执行过程的前后，执行一些逻辑代码。

Rails 在 controller 也有回调，我们下一章会介绍。

### 4.5.2 ActiveRecord 中的回调

一个 ActiveRecord 实例的作用是保存记录，在记录的查找，创建，保存，删除等方法的前后，允许执行一些回调方法。ActiveRecord 在五种情形中提供了 `回调方法`。

第一种，创建对象时的回调。

* before_validation
* after_validation
* before_save
* around_save
* before_create
* around_create
* after_create
* after_save
* after_commit/after_rollback

第二种，更新对象时的回调。

* before_validation
* after_validation
* before_save
* around_save
* before_update
* around_update
* after_update
* after_save
* after_commit/after_rollback

第三种，删除对象时的回调。

* before_destroy
* around_destroy
* after_destroy
* after_commit/after_rollback

第四种，初始化和查找时的回调。

* after_initialize
* after_find

after_initialize 会在初始化一个的实例时触发。

这些方法，会触发 after_find 回调：

* all
* first
* find
* find_by
* find_by_*
* find_by_*!
* find_by_sql
* last

### 4.5.3 触发回调

在我们前面讲解中，更新一个记录时，destroy 方法会触发校验和回调，而 delete 方法不会。在这里详细的列出，ActiveRecord 方法中，哪些会触发回调，哪些不会。

触发回调：

* create
* create!
* decrement!
* destroy
* destroy!
* destroy_all
* increment!
* save
* save!
* save(validate: false)
* toggle!
* update_attribute
* update
* update!
* valid?

不触发回调：

* decrement
* decrement_counter
* delete
* delete_all
* increment
* increment_counter
* toggle
* touch
* update_column
* update_columns
* update_all
* update_counters

### 4.5.4 自定义回调

### 4.5.5 有条件的回调

### 4.5.6 数据库事务中的回调

