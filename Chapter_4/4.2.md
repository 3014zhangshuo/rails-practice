# 4.2 深入模型操作

## 概要：

本课时讲解模型在数据查询时，如何避免 N+1问题，如何使用 scope 包装查询条件，编写模型 Rspec 测试。

## 知识点：

1. N+1
2. Scope
3. Rspec 测试

## 正文

### 4.2.1 两个 Gem

ActiveRecord 这个 gem 中，包含了两个重要的 gem，打开它的 [源代码](https://github.com/rails/rails/blob/master/activerecord/activerecord.gemspec)，可以看到这两个 gem：[activemodel](https://github.com/rails/rails/tree/master/activemodel) 和 [arel](https://github.com/rails/arel)。

`activemodel` 为一个类增加了许多特性，比如属性校验，回调等，这在后面章节会介绍。

`arel` 是 Ruby 编写的 sql 工具，使用它可以编写复杂 sql 语句，我们上面使用的例子，都是在 arel 基础上的。

ActiveRecord 在使用 arel 的时候，提供了一个方法：sanitize_sql。

在我们以上的讲解中，会经常传递这样的参数 `["name = ? and price=?", "foobar", 4]`，它会由 `sanitize_sql` 方法进行处理，这是一个 protected 方法，我们使用 send 来调用它：

```
Product.send(:sanitize_sql, ["name = ? and price=?", "Shoes", 4])
=> "name = 'Shoes' and price=4"
```

这是一种安全的手段，保护我们的 sql 不会被插入恶意代码。我们不必去直接使用这个方法，除非特殊情况，我们只需要按照它的格式要求来书写就可以了。

### 4.2.2 N+1

N+1 是查询中经常遇到的一个问题，无论普通的查询，还是在下一节里的关联关系的查询

### 4.2.3 查询中使用 Scope

### 4.2.4 Rspec 测试


